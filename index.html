<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chunky Chicken • Stock List</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#121826; --muted:#6b7280;
      --pri:#4f46e5; --pri2:#4338ca; --danger:#ef4444; --ok:#16a34a;
      --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#f3f4ff, var(--bg));
      color:var(--text);
    }
    .wrap{max-width:980px; margin:28px auto; padding:0 14px}
    h1{margin:0 0 6px; font-size:30px}
    .sub{color:var(--muted); margin:0 0 18px}
    .grid{display:grid; gap:14px; grid-template-columns:1fr}
    @media(min-width:920px){ .grid{grid-template-columns:380px 1fr} }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:12px; color:var(--muted); display:block; margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--border);
      outline:none; background:#fff; font-size:15px;
    }
    input:focus, select:focus, textarea:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    .btn{
      border:none; border-radius:14px; padding:12px 14px; font-weight:700;
      cursor:pointer; transition:.15s; font-size:15px;
    }
    .btn-primary{background:var(--pri); color:#fff}
    .btn-primary:hover{background:var(--pri2)}
    .btn-ghost{background:#eef2ff; color:#111827}
    .btn-danger{background:#fee2e2; color:#991b1b}
    .btn-danger:hover{background:#fecaca}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
      border-radius:999px; border:1px solid var(--border); background:#fff;
      font-weight:650;
    }
    .status{
      border-radius:14px; padding:10px 12px; font-weight:650; border:1px solid var(--border);
      background:#fff;
    }
    .status.ok{border-color:#bbf7d0; background:#dcfce7; color:#065f46}
    .status.err{border-color:#fecaca; background:#fee2e2; color:#7f1d1d}
    .status.warn{border-color:#fde68a; background:#fffbeb; color:#92400e}

    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:left; padding:0 10px}
    td{
      background:#fff; border:1px solid var(--border);
      padding:12px 10px; vertical-align:middle;
    }
    tr td:first-child{border-top-left-radius:14px; border-bottom-left-radius:14px}
    tr td:last-child{border-top-right-radius:14px; border-bottom-right-radius:14px}

    .small{font-size:12px; color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .actions{display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap}
    .tag{
      display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff; font-size:12px; color:#111827;
    }
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none;
      align-items:center; justify-content:center; padding:18px; z-index:50;
    }
    .modal{max-width:520px; width:100%}
    .modalBack.show{display:flex}
    .kpi{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Stock List</h1>
    <p class="sub">Real-time stock synced via Firestore • Chunky Chicken</p>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label>Search item / location / supplier</label>
            <input id="search" placeholder="Search..." />
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:160px">
            <label>Supplier filter</label>
            <select id="supplierFilter">
              <option value="">All suppliers</option>
            </select>
          </div>

          <div style="flex:1; min-width:160px">
            <label>Stock filter</label>
            <select id="stockFilter">
              <option value="all">All stock</option>
              <option value="low">Low stock (≤ 3)</option>
              <option value="out">Out of stock (= 0)</option>
            </select>
          </div>
        </div>

        <div class="kpi">
          <span class="pill">Items: <span id="count" class="mono">0</span></span>
          <span class="pill">Low: <span id="lowCount" class="mono">0</span></span>
        </div>

        <div style="margin-top:12px">
          <div id="status" class="status warn">Connecting…</div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border); margin:14px 0"/>

        <!-- Admin -->
        <div id="adminGate">
          <button id="enterAdminBtn" class="btn btn-primary" style="width:100%">Enter Admin Mode</button>
          <p class="small" style="margin:10px 0 0">
            Tip: Admin mode enables Add / Edit / Delete. (This is a simple password gate.)
          </p>
        </div>

        <div id="adminPanel" style="display:none">
          <div class="status ok">Admin Mode ON</div>

          <h3 style="margin:14px 0 8px">Add new item</h3>

          <label>Item name</label>
          <input id="name" placeholder='Item name (e.g. "Mozzarella grated cheese")' />

          <label>Supplier</label>
          <input id="supplier" placeholder="Supplier (e.g. Spice Direct Order)" />

          <label>Location</label>
          <input id="location" placeholder="Location (e.g. Freezer)" />

          <label>Quantity</label>
          <input id="qty" inputmode="decimal" placeholder="Quantity (e.g. 12 or 1.5)" />

          <button id="addBtn" class="btn btn-primary" style="width:100%; margin-top:12px">Add Item</button>
          <button id="exitAdminBtn" class="btn btn-danger" style="width:100%; margin-top:10px">Exit Admin</button>

          <p class="small" style="margin:10px 0 0">
            For real security later, use Firebase Auth. This gate is only to stop casual edits.
          </p>
        </div>
      </div>

      <!-- RIGHT: List -->
      <div class="card">
        <h2 style="margin:0 0 10px">Stock List</h2>
        <div class="small" id="hint"></div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px">Item</th>
                <th style="min-width:140px">Supplier</th>
                <th style="min-width:120px">Location</th>
                <th style="min-width:90px">Qty</th>
                <th style="min-width:160px">Updated</th>
                <th style="min-width:210px; text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="modalBack" class="modalBack" role="dialog" aria-modal="true">
    <div class="card modal">
      <h3 style="margin:0 0 10px">Edit item</h3>

      <div class="small" id="editId"></div>

      <label>Item name</label>
      <input id="editName" />

      <label>Supplier</label>
      <input id="editSupplier" />

      <label>Location</label>
      <input id="editLocation" />

      <label>Quantity</label>
      <input id="editQty" inputmode="decimal" />

      <div class="row" style="margin-top:12px">
        <button id="saveEditBtn" class="btn btn-primary" style="flex:1">Save</button>
        <button id="cancelEditBtn" class="btn btn-ghost" style="flex:1">Cancel</button>
      </div>

      <div id="editStatus" class="status warn" style="margin-top:10px; display:none"></div>
    </div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    // ====== YOUR FIREBASE CONFIG (provided by you) ======
    const firebaseConfig = {
      apiKey: "AIzaSyC1a-QH7GDbyf47QfsvDia3sHReBN9ALho",
      authDomain: "internal-stock-d055b.firebaseapp.com",
      projectId: "internal-stock-d055b",
      storageBucket: "internal-stock-d055b.firebasestorage.app",
      messagingSenderId: "755909434320",
      appId: "1:755909434320:web:6b24b882d6c86831ca77d5"
    };

    // ====== SETTINGS YOU CAN CHANGE ======
    const COLLECTION_NAME = "stockItems"; // Firestore collection name
    const LOW_STOCK_THRESHOLD = 3;
    const ADMIN_LOCAL_KEY = "cc_admin_enabled_v1";
    const ADMIN_PASS_KEY = "cc_admin_pass_v1"; // stores your chosen admin password locally (device browser)

    // ====== IMPORTS ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, deleteDoc, updateDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ====== INIT ======
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const hintEl = $("hint");
    const tbody = $("tbody");

    const searchEl = $("search");
    const supplierFilterEl = $("supplierFilter");
    const stockFilterEl = $("stockFilter");

    const countEl = $("count");
    const lowCountEl = $("lowCount");

    const adminGate = $("adminGate");
    const adminPanel = $("adminPanel");
    const enterAdminBtn = $("enterAdminBtn");
    const exitAdminBtn = $("exitAdminBtn");

    const nameEl = $("name");
    const supplierEl = $("supplier");
    const locationEl = $("location");
    const qtyEl = $("qty");
    const addBtn = $("addBtn");

    // Modal
    const modalBack = $("modalBack");
    const editIdEl = $("editId");
    const editNameEl = $("editName");
    const editSupplierEl = $("editSupplier");
    const editLocationEl = $("editLocation");
    const editQtyEl = $("editQty");
    const saveEditBtn = $("saveEditBtn");
    const cancelEditBtn = $("cancelEditBtn");
    const editStatus = $("editStatus");

    // ====== STATE ======
    let allItems = []; // {id, name, supplier, location, qty, updatedAt}
    let adminEnabled = localStorage.getItem(ADMIN_LOCAL_KEY) === "1";
    let currentEditId = null;

    // ====== HELPERS ======
    function setStatus(type, msg){
      statusEl.className = "status " + (type || "warn");
      statusEl.textContent = msg;
    }

    function showError(msg){
      setStatus("err", msg);
      console.error(msg);
    }

    function showOk(msg){
      setStatus("ok", msg);
    }

    function normalize(s){ return (s ?? "").toString().trim(); }

    function parseQty(v){
      const t = normalize(v).replace(",", ".");
      if(t === "") return NaN;
      const n = Number(t);
      return Number.isFinite(n) ? n : NaN;
    }

    function formatTime(ts){
      if(!ts) return "—";
      // Firestore Timestamp has toDate()
      try{
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      }catch{
        return "—";
      }
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function updateAdminUI(){
      if(adminEnabled){
        adminGate.style.display = "none";
        adminPanel.style.display = "block";
      }else{
        adminGate.style.display = "block";
        adminPanel.style.display = "none";
      }
      renderTable();
    }

    function ensureAdminPassword(){
      let pass = localStorage.getItem(ADMIN_PASS_KEY);
      if(!pass){
        pass = prompt("Set an Admin password for this device (you will use it to enter Admin Mode):");
        pass = normalize(pass);
        if(pass.length < 4){
          alert("Password must be at least 4 characters. Try again.");
          return ensureAdminPassword();
        }
        localStorage.setItem(ADMIN_PASS_KEY, pass);
      }
      return pass;
    }

    function enterAdmin(){
      const pass = ensureAdminPassword();
      if(!pass) return;

      const typed = prompt("Enter Admin password:");
      if(normalize(typed) !== pass){
        alert("Wrong password.");
        return;
      }
      adminEnabled = true;
      localStorage.setItem(ADMIN_LOCAL_KEY, "1");
      updateAdminUI();
    }

    function exitAdmin(){
      adminEnabled = false;
      localStorage.removeItem(ADMIN_LOCAL_KEY);
      updateAdminUI();
    }

    // ====== FILTERS ======
    function rebuildSupplierFilter(items){
      const current = supplierFilterEl.value;
      const set = new Set(items.map(i => normalize(i.supplier)).filter(Boolean));
      const suppliers = Array.from(set).sort((a,b)=>a.localeCompare(b));

      supplierFilterEl.innerHTML = `<option value="">All suppliers</option>` +
        suppliers.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

      // keep selection if still exists
      if(suppliers.includes(current)) supplierFilterEl.value = current;
      else supplierFilterEl.value = "";
    }

    function applyFilters(items){
      const q = normalize(searchEl.value).toLowerCase();
      const sup = normalize(supplierFilterEl.value);
      const stockMode = stockFilterEl.value;

      return items.filter(it=>{
        const blob = `${it.name} ${it.supplier} ${it.location}`.toLowerCase();
        if(q && !blob.includes(q)) return false;
        if(sup && normalize(it.supplier) !== sup) return false;

        if(stockMode === "low" && !(Number(it.qty) <= LOW_STOCK_THRESHOLD)) return false;
        if(stockMode === "out" && !(Number(it.qty) === 0)) return false;

        return true;
      });
    }

    // ====== RENDER ======
    function renderTable(){
      const filtered = applyFilters(allItems);

      countEl.textContent = String(allItems.length);
      lowCountEl.textContent = String(allItems.filter(i => Number(i.qty) <= LOW_STOCK_THRESHOLD).length);

      if(filtered.length === 0){
        hintEl.textContent = "No items match your filters.";
      }else{
        hintEl.textContent = "";
      }

      tbody.innerHTML = filtered.map(it=>{
        const qty = Number(it.qty);
        const qtyBadge = qty === 0
          ? `<span class="tag" title="Out of stock">Out: ${qty}</span>`
          : qty <= LOW_STOCK_THRESHOLD
            ? `<span class="tag" title="Low stock">Low: ${qty}</span>`
            : `<span class="tag" title="In stock">Qty: ${qty}</span>`;

        const actions = adminEnabled
          ? `
            <div class="actions">
              <button class="btn btn-ghost" data-act="edit" data-id="${it.id}">Edit</button>
              <button class="btn btn-danger" data-act="del" data-id="${it.id}">Delete</button>
            </div>
          `
          : `<div class="actions"><span class="small">Admin only</span></div>`;

        return `
          <tr>
            <td><strong>${escapeHtml(it.name)}</strong></td>
            <td>${escapeHtml(it.supplier || "—")}</td>
            <td>${escapeHtml(it.location || "—")}</td>
            <td>${qtyBadge}</td>
            <td class="small">${escapeHtml(formatTime(it.updatedAt))}</td>
            <td style="text-align:right">${actions}</td>
          </tr>
        `;
      }).join("");

      // Wire row buttons
      tbody.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if(act === "del") await handleDelete(id);
          if(act === "edit") openEdit(id);
        });
      });
    }

    // ====== CRUD ======
    async function handleAdd(){
      try{
        addBtn.disabled = true;

        const name = normalize(nameEl.value);
        const supplier = normalize(supplierEl.value);
        const location = normalize(locationEl.value);
        const qty = parseQty(qtyEl.value);

        // Validation (error messages)
        if(!adminEnabled) throw new Error("Admin mode is OFF. Enter Admin Mode first.");
        if(name.length < 2) throw new Error("Item name is required (at least 2 characters).");
        if(!Number.isFinite(qty) || qty < 0) throw new Error("Quantity must be a number (0 or more).");

        await addDoc(collection(db, COLLECTION_NAME), {
          name,
          supplier,
          location,
          qty,
          updatedAt: serverTimestamp()
        });

        // Clear form
        nameEl.value = "";
        supplierEl.value = supplier; // keep last supplier for speed
        locationEl.value = location; // keep last location for speed
        qtyEl.value = "";

        showOk("Item added ✅");
      }catch(err){
        showError(err?.message || "Add failed.");
        alert(err?.message || "Add failed.");
      }finally{
        addBtn.disabled = false;
      }
    }

    async function handleDelete(id){
      try{
        if(!adminEnabled) throw new Error("Admin mode is OFF. Enter Admin Mode first.");
        const item = allItems.find(x=>x.id===id);
        const ok = confirm(`Delete this item?\n\n${item?.name || id}`);
        if(!ok) return;

        await deleteDoc(doc(db, COLLECTION_NAME, id));
        showOk("Item deleted ✅");
      }catch(err){
        showError(err?.message || "Delete failed.");
        alert(err?.message || "Delete failed.");
      }
    }

    function openEdit(id){
      if(!adminEnabled){
        alert("Admin mode is OFF. Enter Admin Mode first.");
        return;
      }
      const item = allItems.find(x=>x.id===id);
      if(!item){
        alert("Item not found.");
        return;
      }
      currentEditId = id;

      editIdEl.textContent = "ID: " + id;
      editNameEl.value = item.name ?? "";
      editSupplierEl.value = item.supplier ?? "";
      editLocationEl.value = item.location ?? "";
      editQtyEl.value = String(item.qty ?? "");

      editStatus.style.display = "none";
      editStatus.textContent = "";

      modalBack.classList.add("show");
    }

    function closeEdit(){
      currentEditId = null;
      modalBack.classList.remove("show");
    }

    async function saveEdit(){
      try{
        if(!adminEnabled) throw new Error("Admin mode is OFF. Enter Admin Mode first.");
        if(!currentEditId) throw new Error("No item selected.");

        saveEditBtn.disabled = true;

        const name = normalize(editNameEl.value);
        const supplier = normalize(editSupplierEl.value);
        const location = normalize(editLocationEl.value);
        const qty = parseQty(editQtyEl.value);

        if(name.length < 2) throw new Error("Item name is required (at least 2 characters).");
        if(!Number.isFinite(qty) || qty < 0) throw new Error("Quantity must be a number (0 or more).");

        await updateDoc(doc(db, COLLECTION_NAME, currentEditId), {
          name, supplier, location, qty,
          updatedAt: serverTimestamp()
        });

        editStatus.className = "status ok";
        editStatus.textContent = "Saved ✅";
        editStatus.style.display = "block";

        // small delay so user sees it, then close
        setTimeout(closeEdit, 450);
      }catch(err){
        editStatus.className = "status err";
        editStatus.textContent = err?.message || "Update failed.";
        editStatus.style.display = "block";
      }finally{
        saveEditBtn.disabled = false;
      }
    }

    // ====== REALTIME LISTEN ======
    function startListener(){
      setStatus("warn", "Connecting…");
      const qy = query(collection(db, COLLECTION_NAME), orderBy("updatedAt", "desc"));

      onSnapshot(qy, (snap)=>{
        allItems = snap.docs.map(d=>{
          const data = d.data();
          return {
            id: d.id,
            name: data.name ?? "",
            supplier: data.supplier ?? "",
            location: data.location ?? "",
            qty: Number(data.qty ?? 0),
            updatedAt: data.updatedAt ?? null
          };
        });

        rebuildSupplierFilter(allItems);
        renderTable();
        showOk("Connected. Live updates are ON ✅");
      }, (err)=>{
        // Common issues: Firestore disabled, rules blocking, wrong config.
        showError("Firestore error: " + (err?.message || "Unknown"));
        alert("Firestore error:\n\n" + (err?.message || "Unknown") + "\n\nFix Firestore rules / enable Firestore.");
      });
    }

    // ====== EVENTS ======
    enterAdminBtn.addEventListener("click", enterAdmin);
    exitAdminBtn.addEventListener("click", exitAdmin);
    addBtn.addEventListener("click", handleAdd);

    [searchEl, supplierFilterEl, stockFilterEl].forEach(el=>{
      el.addEventListener("input", renderTable);
      el.addEventListener("change", renderTable);
    });

    cancelEditBtn.addEventListener("click", closeEdit);
    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack) closeEdit();
    });
    saveEditBtn.addEventListener("click", saveEdit);

    // Enter key on add form:
    [nameEl, supplierEl, locationEl, qtyEl].forEach(el=>{
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") handleAdd();
      });
    });

    // ====== START ======
    updateAdminUI();
    startListener();
  </script>
</body>
</html>

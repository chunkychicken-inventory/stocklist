<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock List (Firestore)</title>
  <style>
    :root{
      --bg:#f6f7ff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --brand:#4f46e5;
      --danger:#ef4444;
      --border:#e5e7eb;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#eef2ff 0%, var(--bg) 60%, #fff 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:26px auto;padding:0 14px}
    header{margin-bottom:14px}
    h1{margin:0;font-size:30px;letter-spacing:-.02em}
    .sub{color:var(--muted);margin-top:6px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px; margin:14px 0;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .row .small{flex:.8}
    input,select,button{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--border);
      background:#fff; font-size:15px; outline:none;
    }
    input:focus,select:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(79,70,229,.12)}
    button{border:none; cursor:pointer; font-weight:700}
    .btn{background:var(--brand); color:white}
    .btn:hover{filter:brightness(.96)}
    .btn-outline{background:#fff; border:1px solid var(--border); color:var(--text)}
    .btn-danger{background:var(--danger); color:#fff}
    .btn-muted{background:#f3f4f6; color:var(--text)}
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:7px 10px;
      border-radius:999px; font-weight:700; font-size:13px;
      border:1px solid var(--border); background:#fff;
    }
    .pill.warn{background:#fffbeb;border-color:#fcd34d;color:#92400e}
    .pill.danger{background:#fee2e2;border-color:#fca5a5;color:#7f1d1d}
    .banner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      background:#ecfeff;
    }
    .banner strong{color:#0f766e}
    .adminbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-radius:14px;
      background:#dcfce7; border:1px solid #86efac; margin-top:10px;
    }
    .adminbar strong{color:#166534}
    .grid{
      overflow:auto;
      border:1px solid var(--border); border-radius:14px;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      min-width:920px;
    }
    thead th{
      position:sticky; top:0;
      background:#f9fafb; border-bottom:1px solid var(--border);
      padding:12px; text-align:left; font-size:13px; color:#374151;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:12px; vertical-align:middle; font-size:14px;
    }
    tbody tr:hover{background:#fafafa}
    .itemname{font-weight:800}
    .muted{color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .qtybox{display:flex; align-items:center; gap:8px}
    .qtynum{
      min-width:44px; text-align:center; font-weight:900;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff;
    }
    .qtybtn{
      width:auto; padding:8px 10px; border-radius:10px; font-weight:900;
      background:#eef2ff; color:#1f2937; border:1px solid #c7d2fe;
    }
    .qtybtn:active{transform:translateY(1px)}
    .footnote{color:var(--muted); font-size:13px; margin-top:8px}

    /* toast */
    .toasts{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); width:min(520px,92vw); z-index:9999; display:flex; flex-direction:column; gap:10px}
    .toast{
      background:#111827; color:#fff; padding:12px 14px; border-radius:14px;
      box-shadow:0 15px 30px rgba(0,0,0,.18);
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .toast .t{font-size:14px; line-height:1.35}
    .toast .x{background:transparent; border:none; color:#fff; font-size:18px; padding:0; width:auto; cursor:pointer}
    .toast.ok{background:#065f46}
    .toast.err{background:#7f1d1d}
    .toast.warn{background:#92400e}

    /* modal */
    dialog{
      border:none; border-radius:18px; padding:0; width:min(560px,92vw);
      box-shadow:0 25px 60px rgba(0,0,0,.25);
    }
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:14px;background:#fff}
    .modal h3{margin:0 0 10px 0}
    .modal .row{margin-top:10px}
    .modal .actions{justify-content:flex-end; margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Stock List</h1>
      <div class="sub">Real-time stock synced via Firestore • Chunky Chicken</div>
    </header>

    <div class="card">
      <div class="row">
        <input id="search" placeholder="Search item / location / supplier" />
        <div class="small">
          <label class="muted" style="font-size:12px;display:block;margin:0 0 6px 4px;">Supplier filter</label>
          <select id="supplierFilter"></select>
        </div>
        <div class="small">
          <label class="muted" style="font-size:12px;display:block;margin:0 0 6px 4px;">Stock filter</label>
          <select id="stockFilter">
            <option value="all">All stock</option>
            <option value="low">Low stock (≤ 3)</option>
            <option value="out">Out of stock (0)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="pill"><span>Items:</span> <span id="countAll">0</span></div>
        <div class="pill warn"><span>Low:</span> <span id="countLow">0</span></div>
        <div class="pill danger"><span>Out:</span> <span id="countOut">0</span></div>
      </div>

      <div style="margin-top:12px" class="banner">
        <div><strong id="connText">Connecting…</strong> <span class="muted" id="connSub"></span></div>
        <div class="row" style="margin:0; gap:10px">
          <button id="adminBtn" class="btn" style="width:auto; padding:12px 14px;">Enter Admin Mode</button>
          <button id="refreshBtn" class="btn-outline" style="width:auto; padding:12px 14px;">Refresh</button>
        </div>
      </div>

      <div id="adminBar" class="adminbar" style="display:none;">
        <div><strong>Admin Mode ON</strong> <span class="muted">Add / Edit / Delete enabled</span></div>
        <button id="exitAdminBtn" class="btn-danger" style="width:auto; padding:10px 12px;">Exit Admin</button>
      </div>

      <div class="footnote">
        ✅ Fix applied: items no longer jump to the top when you update quantity.
      </div>
    </div>

    <div class="card" id="adminPanel" style="display:none;">
      <h2 style="margin:0 0 12px 0;">Add new item</h2>
      <div class="row">
        <input id="newName" placeholder='Item name (e.g. "Mozzarella grated cheese")' />
        <select id="newSupplier" class="small"></select>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="newLocation" placeholder="Location (e.g. Freezer)" />
        <input id="newQty" placeholder="Quantity (e.g. 12 or 1.5)" inputmode="decimal" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="addBtn" class="btn">Add Item</button>
      </div>
      <div class="footnote">Tip: Admin mode is required for Add / Edit / Delete. Staff can always adjust quantity with + / −.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 12px 0;">Stock List</h2>
      <div class="grid">
        <table>
          <thead>
            <tr>
              <th style="width:28%">Item</th>
              <th style="width:18%">Supplier</th>
              <th style="width:16%">Location</th>
              <th style="width:14%">Qty</th>
              <th style="width:16%">Updated</th>
              <th style="width:18%">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footnote">
        Staff: use <strong>+ / −</strong> to change quantity. Admin: can also Edit details or Delete items.
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <dialog id="editDialog">
    <div class="modal">
      <h3>Edit item (Admin)</h3>
      <div class="row">
        <input id="editName" placeholder="Item name" />
        <select id="editSupplier" class="small"></select>
      </div>
      <div class="row">
        <input id="editLocation" placeholder="Location" />
        <input id="editQty" placeholder="Quantity" inputmode="decimal" />
      </div>
      <div class="actions">
        <button id="editCancel" class="btn-outline" style="width:auto;">Cancel</button>
        <button id="editSave" class="btn" style="width:auto;">Save</button>
      </div>
      <div class="footnote">Edit changes name/supplier/location/qty. Staff can’t access this.</div>
    </div>
  </dialog>

  <script type="module">
    /**********************
     * 1) CHANGE THIS PASSWORD
     **********************/
    const ADMIN_PASSWORD = "1234"; // <-- change to your password

    /**********************
     * 2) YOUR FIREBASE CONFIG (yours)
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyC1a-QH7GDbyf47QfsvDia3sHReBN9ALho",
      authDomain: "internal-stock-d055b.firebaseapp.com",
      projectId: "internal-stock-d055b",
      storageBucket: "internal-stock-d055b.firebasestorage.app",
      messagingSenderId: "755909434320",
      appId: "1:755909434320:web:6b24b882d6c86831ca77d5"
    };

    /**********************
     * Firebase v9 (modular) CDN
     **********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot,
      query, orderBy, serverTimestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collection name
    const itemsCol = collection(db, "items");

    /**********************
     * Supplier list (Boss request)
     **********************/
    const DEFAULT_SUPPLIERS = [
      "Caterchoice Order",
      "Spice Direct Order",
      "Brakes",
      "Chunky Meat",
      "Cook’d Brands (CKD)",
      "Adam Foods"
    ];

    function loadSuppliers(){
      try{
        const saved = JSON.parse(localStorage.getItem("suppliersList") || "[]");
        const set = new Set([...DEFAULT_SUPPLIERS, ...saved].map(s => String(s).trim()).filter(Boolean));
        return Array.from(set);
      }catch{
        return [...DEFAULT_SUPPLIERS];
      }
    }

    function saveSuppliers(list){
      const cleaned = Array.from(new Set(list.map(s => String(s).trim()).filter(Boolean)));
      // Store only non-default additions
      const extras = cleaned.filter(s => !DEFAULT_SUPPLIERS.includes(s));
      localStorage.setItem("suppliersList", JSON.stringify(extras));
    }

    let suppliersList = loadSuppliers();

    /**********************
     * UI helpers
     **********************/
    const $ = (id) => document.getElementById(id);

    function toast(type, msg){
      const wrap = $("toasts");
      const t = document.createElement("div");
      t.className = "toast " + (type || "");
      t.innerHTML = `<div class="t">${msg}</div><button class="x" aria-label="Close">×</button>`;
      t.querySelector(".x").onclick = () => t.remove();
      wrap.appendChild(t);
      setTimeout(()=>{ if(t.isConnected) t.remove(); }, 4500);
    }

    function safeNumber(v){
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function formatTime(ts){
      try{
        if(!ts) return "—";
        const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if(!d) return "—";
        const pad = (x)=> String(x).padStart(2,"0");
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch{
        return "—";
      }
    }

    function norm(s){ return String(s || "").trim(); }
    function normLower(s){ return norm(s).toLowerCase(); }

    /**********************
     * Admin state (localStorage)
     **********************/
    let isAdmin = localStorage.getItem("isAdmin") === "true";

    function setAdminUI(){
      $("adminBar").style.display = isAdmin ? "flex" : "none";
      $("adminPanel").style.display = isAdmin ? "block" : "none";
      $("adminBtn").textContent = isAdmin ? "Admin Mode Enabled" : "Enter Admin Mode";
      $("adminBtn").className = isAdmin ? "btn-muted" : "btn";
      $("adminBtn").disabled = isAdmin;
    }

    $("adminBtn").addEventListener("click", () => {
      const pw = prompt("Enter admin password:");
      if(pw === null) return;
      if(pw === ADMIN_PASSWORD){
        isAdmin = true;
        localStorage.setItem("isAdmin","true");
        toast("ok","Admin mode enabled.");
        setAdminUI();
        renderTable();
      }else{
        toast("err","Wrong password.");
      }
    });

    $("exitAdminBtn").addEventListener("click", () => {
      isAdmin = false;
      localStorage.setItem("isAdmin","false");
      toast("warn","Admin mode disabled.");
      setAdminUI();
      renderTable();
    });

    /**********************
     * Data
     **********************/
    let items = []; // {id, name, supplier, location, qty, updatedAt, nameLower}

    // ✅ IMPORTANT FIX:
    // We order by a stable field so rows do NOT jump when updatedAt changes.
    // If nameLower doesn't exist on older items, they may appear first; once edited, it will be set.
    const qItems = query(itemsCol, orderBy("nameLower", "asc"));

    let firstSnapshot = false;

    onSnapshot(qItems, (snap) => {
      firstSnapshot = true;
      items = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      $("connText").textContent = "Connected. Live updates are ON ✅";
      $("connSub").textContent = "";

      // keep suppliers dynamic if new supplier appears in DB
      const dbSuppliers = items.map(it => norm(it.supplier)).filter(Boolean);
      const set = new Set([...suppliersList, ...dbSuppliers]);
      suppliersList = Array.from(set);
      saveSuppliers(suppliersList);

      renderSupplierFilter();
      renderSupplierSelects();
      renderCounts();
      renderTable();
    }, (err) => {
      $("connText").textContent = "Connection error";
      $("connSub").textContent = err?.message ? err.message : "Check Firestore rules / config";
      toast("err", "Firestore error: " + (err?.message || "Unknown error"));
    });

    setTimeout(() => {
      if(!firstSnapshot){
        $("connText").textContent = "Connecting…";
        $("connSub").textContent = "If this stays, check Firestore rules and config.";
      }
    }, 1200);

    /**********************
     * Supplier UI
     **********************/
    function renderSupplierSelects(){
      const makeOptions = (selectEl, includeAddNew) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";

        suppliersList.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          selectEl.appendChild(opt);
        });

        if(includeAddNew){
          const opt = document.createElement("option");
          opt.value = "__add__";
          opt.textContent = "➕ Add new supplier…";
          selectEl.appendChild(opt);
        }

        // restore selection if possible
        if([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
      };

      makeOptions($("newSupplier"), true);
      makeOptions($("editSupplier"), true);

      const onAddNew = (selectEl) => {
        if(selectEl.value !== "__add__") return;
        const name = prompt("Enter new supplier name (e.g. Brakes / Cook’d Brands (CKD)):");
        if(!name) { selectEl.value = suppliersList[0] || ""; return; }
        const clean = norm(name);
        if(!clean) { selectEl.value = suppliersList[0] || ""; return; }

        if(!suppliersList.includes(clean)){
          suppliersList.push(clean);
          suppliersList.sort((a,b)=>a.localeCompare(b));
          saveSuppliers(suppliersList);
        }
        renderSupplierFilter();
        renderSupplierSelects();
        selectEl.value = clean;
        toast("ok", `Supplier added: <strong>${clean}</strong>`);
      };

      $("newSupplier").onchange = () => onAddNew($("newSupplier"));
      $("editSupplier").onchange = () => onAddNew($("editSupplier"));
    }

    function renderSupplierFilter(){
      const select = $("supplierFilter");
      const current = select.value || "all";

      const distinct = new Set(suppliersList);
      items.forEach(it => {
        const s = norm(it.supplier);
        if(s) distinct.add(s);
      });

      const opts = ["All suppliers", ...Array.from(distinct).sort((a,b)=>a.localeCompare(b))];
      select.innerHTML = "";
      opts.forEach((label, idx) => {
        const opt = document.createElement("option");
        opt.value = idx === 0 ? "all" : label;
        opt.textContent = label;
        select.appendChild(opt);
      });

      if([...select.options].some(o => o.value === current)){
        select.value = current;
      }else{
        select.value = "all";
      }
    }

    /**********************
     * Filters
     **********************/
    function passesFilters(it){
      const s = $("search").value.trim().toLowerCase();
      const supplier = $("supplierFilter").value;
      const stock = $("stockFilter").value;

      const hay = [
        it.name || "",
        it.location || "",
        it.supplier || ""
      ].join(" ").toLowerCase();

      if(s && !hay.includes(s)) return false;

      if(supplier !== "all"){
        if(norm(it.supplier) !== supplier) return false;
      }

      const qty = Number(it.qty ?? 0);
      if(stock === "low" && !(qty > 0 && qty <= 3)) return false;
      if(stock === "out" && !(qty === 0)) return false;

      return true;
    }

    $("search").addEventListener("input", () => renderTable());
    $("supplierFilter").addEventListener("change", () => renderTable());
    $("stockFilter").addEventListener("change", () => renderTable());
    $("refreshBtn").addEventListener("click", () => {
      toast("", "Refreshed.");
      renderCounts();
      renderTable();
    });

    function renderCounts(){
      const all = items.length;
      const low = items.filter(i => Number(i.qty ?? 0) > 0 && Number(i.qty ?? 0) <= 3).length;
      const out = items.filter(i => Number(i.qty ?? 0) === 0).length;

      $("countAll").textContent = all;
      $("countLow").textContent = low;
      $("countOut").textContent = out;
    }

    /**********************
     * Staff quantity controls (always available)
     **********************/
    async function changeQty(id, delta){
      try{
        const ref = doc(db, "items", id);

        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if(!snap.exists()) throw new Error("Item no longer exists.");

          const cur = Number(snap.data().qty ?? 0);
          const next = cur + delta;
          if(next < 0) throw new Error("Quantity cannot go below 0.");

          tx.update(ref, {
            qty: next,
            updatedAt: serverTimestamp()
          });
        });

      }catch(err){
        toast("err", err?.message || "Failed to update quantity. Check Firestore rules.");
      }
    }

    /**********************
     * Admin actions (add / edit / delete)
     **********************/
    $("addBtn").addEventListener("click", async () => {
      if(!isAdmin){
        toast("err","Admin only.");
        return;
      }

      const name = $("newName").value.trim();
      const supplier = norm($("newSupplier").value) || "—";
      const location = $("newLocation").value.trim() || "Not specified";
      const qty = safeNumber($("newQty").value);

      if(!name){
        toast("warn","Please enter an item name.");
        return;
      }
      if(qty === null || qty < 0){
        toast("warn","Please enter a valid quantity (0 or more).");
        return;
      }

      try{
        await addDoc(itemsCol, {
          name,
          nameLower: normLower(name),   // ✅ stable sorting field
          supplier,
          location,
          qty,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        $("newName").value = "";
        $("newLocation").value = "";
        $("newQty").value = "";
        toast("ok","Item added.");
      }catch(err){
        toast("err", err?.message || "Failed to add item. Check Firestore rules.");
      }
    });

    async function adminDelete(id){
      if(!isAdmin) return toast("err","Admin only.");
      const ok = confirm("Delete this item? This cannot be undone.");
      if(!ok) return;

      try{
        await deleteDoc(doc(db, "items", id));
        toast("ok","Item deleted.");
      }catch(err){
        toast("err", err?.message || "Failed to delete item. Check Firestore rules.");
      }
    }

    // Edit modal
    const editDialog = $("editDialog");
    let editingId = null;

    function openEdit(item){
      if(!isAdmin) return toast("err","Admin only.");

      editingId = item.id;
      $("editName").value = item.name || "";
      $("editSupplier").value = norm(item.supplier) || suppliersList[0] || "Caterchoice Order";
      $("editLocation").value = item.location || "";
      $("editQty").value = String(item.qty ?? 0);

      editDialog.showModal();
    }

    $("editCancel").addEventListener("click", () => {
      editingId = null;
      editDialog.close();
    });

    $("editSave").addEventListener("click", async () => {
      if(!isAdmin) return toast("err","Admin only.");
      if(!editingId) return;

      const name = $("editName").value.trim();
      const supplier = norm($("editSupplier").value) || "—";
      const location = $("editLocation").value.trim() || "Not specified";
      const qty = safeNumber($("editQty").value);

      if(!name){
        toast("warn","Please enter an item name.");
        return;
      }
      if(qty === null || qty < 0){
        toast("warn","Please enter a valid quantity (0 or more).");
        return;
      }

      try{
        await updateDoc(doc(db,"items",editingId), {
          name,
          nameLower: normLower(name),   // ✅ keep stable sorting field updated
          supplier,
          location,
          qty,
          updatedAt: serverTimestamp()
        });

        toast("ok","Item updated.");
        editingId = null;
        editDialog.close();
      }catch(err){
        toast("err", err?.message || "Failed to save. Check Firestore rules.");
      }
    });

    /**********************
     * Render table
     **********************/
    function renderTable(){
      const tbody = $("tbody");
      tbody.innerHTML = "";

      // ✅ stable order (already from Firestore by nameLower)
      const filtered = items.filter(passesFilters);

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted" style="padding:18px;">No items match your filters.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for(const it of filtered){
        const qty = Number(it.qty ?? 0);
        const supplier = norm(it.supplier) || "—";
        const location = norm(it.location) || "Not specified";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="itemname">${it.name || "—"}</div>
            <div class="muted" style="font-size:12px;">ID: ${it.id}</div>
          </td>
          <td>${supplier}</td>
          <td>${location}</td>
          <td>
            <div class="qtybox">
              <button class="qtybtn" data-act="minus" title="Decrease">−</button>
              <div class="qtynum">${qty}</div>
              <button class="qtybtn" data-act="plus" title="Increase">+</button>
            </div>
          </td>
          <td class="muted">${formatTime(it.updatedAt)}</td>
          <td>
            <div class="actions">
              ${isAdmin ? `<button class="btn-outline" data-act="edit">Edit</button>` : ``}
              ${isAdmin ? `<button class="btn-danger" data-act="delete">Delete</button>` : ``}
            </div>
          </td>
        `;

        // staff +/- works always
        tr.querySelector('[data-act="minus"]').onclick = () => changeQty(it.id, -1);
        tr.querySelector('[data-act="plus"]').onclick = () => changeQty(it.id, +1);

        if(isAdmin){
          tr.querySelector('[data-act="edit"]').onclick = () => openEdit(it);
          tr.querySelector('[data-act="delete"]').onclick = () => adminDelete(it.id);
        }

        tbody.appendChild(tr);
      }
    }

    // start UI
    setAdminUI();
    renderSupplierSelects();
    renderSupplierFilter();
  </script>
</body>
</html>
